<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIEC – ダウンロード</title>
  <style>
    body{margin:0;background:#0f172a;color:#e2e8f0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:800px;margin:40px auto;padding:0 16px}
    .panel{background:#0b1220;border:1px solid #1f2a44;border-radius:16px;padding:20px}
    .muted{opacity:.85}
    .err{color:#fecaca;margin-top:12px;white-space:pre-wrap}
    a{color:#93c5fd}
    button{background:#1e293b;color:#e2e8f0;border:1px solid #334155;border-radius:10px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[readonly]{flex:1;min-width:300px;padding:8px;border-radius:8px;border:1px solid #444;background:#111;color:#ddd}
  </style>
  <script>
    (function(){
      // GATEのベースURL（windowに既に設定されていれば優先）
      const FALLBACK = "https://aiec-gate-766292311890.asia-northeast1.run.app"; // ←二重https修正済み
      const RAW = (window.AIEC_GATE_BASE||FALLBACK);
      const GATE = String(RAW).replace(/^https?:\/\/https?:\/\//,'https://').replace(/\/+$/,'');
      window.AIEC_GATE_BASE = GATE;
    })();
  </script>
</head>
<body>
  <div class="wrap">
    <h1>ダウンロード</h1>

    <!-- ダウンロード操作 -->
    <div class="panel" id="dl-panel">
      <p id="status" class="muted">ダウンロードの準備ができました。下のボタンをクリックしてください。</p>
      <div class="row" style="margin-top:8px">
        <button id="btn-download">今すぐダウンロード</button>
        <a id="a-direct" href="#" class="muted" style="text-decoration:underline">直接リンクを開く</a>
      </div>
      <pre id="error" class="err" style="display:none"></pre>
    </div>

    <!-- ライセンス表示/取得ユーティリティ -->
    <section id="license-tools" class="panel" style="margin-top:20px">
      <h3 style="margin:0 0 12px 0;">ライセンスキー</h3>
      <div class="row">
        <input id="lic-input" type="text" readonly>
        <button id="btn-copy">コピー</button>
        <button id="btn-save">license.txt 保存</button>
        <button id="btn-qr">QR表示</button>
      </div>
      <div id="qr-wrap" style="margin-top:12px; display:none;"></div>
      <p class="muted" style="margin-top:8px">
        ※ 購入時に自動発行されています。見つからない場合は<b>購入に使ったブラウザ</b>でこのページを開いてください。
      </p>
    </section>
  </div>

  <script>
    (async ()=>{
      const GATE = (window.AIEC_GATE_BASE||"").replace(/^https?:\/\/https?:\/\//,'https://').replace(/\/+$/,'');
      const statusEl = document.getElementById("status");
      const errEl    = document.getElementById("error");
      const btn      = document.getElementById("btn-download");
      const aDirect  = document.getElementById("a-direct");

      const $ = (q)=>document.querySelector(q);

      function apiUrl(p){ return new URL(p, GATE).href; }

      // --- ライセンスUI ---
      const licInput = $("#lic-input");
      const copyBtn  = $("#btn-copy");
      const saveBtn  = $("#btn-save");
      const qrBtn    = $("#btn-qr");
      const qrWrap   = $("#qr-wrap");

      const lic = (localStorage.getItem("aiec-license")||"").trim();
      if(!lic){
        licInput.value = "(見つかりませんでした)";
        copyBtn.disabled = saveBtn.disabled = qrBtn.disabled = true;
      }else{
        licInput.value = lic;
        copyBtn.addEventListener("click", async ()=>{
          try{ await navigator.clipboard.writeText(lic); copyBtn.textContent="コピーしました"; setTimeout(()=>copyBtn.textContent="コピー",1200); }
          catch{ alert("コピーに失敗しました"); }
        });
        saveBtn.addEventListener("click", ()=>{
          const blob = new Blob([lic+"\n"], {type:"text/plain"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob); a.download = "license.txt"; a.click();
          URL.revokeObjectURL(a.href);
        });
        qrBtn.addEventListener("click", ()=>{
          qrWrap.style.display = "block"; qrWrap.innerHTML="";
          const c = document.createElement("canvas"); qrWrap.appendChild(c);
          const ctx=c.getContext("2d"); c.width=400; c.height=120;
          ctx.fillStyle="#111"; ctx.fillRect(0,0,c.width,c.height);
          ctx.fillStyle="#0f0"; ctx.font="16px monospace";
          ctx.fillText("aiec:license:"+lic, 10, 60);
        });
      }

      // --- ダウンロードリンクの決定 ---
      // 1) URLに token= がある → それを使う（リダイレクトしない・ボタン押下で開く）
      const tokenQ = new URLSearchParams(location.search).get("token");
      async function getSignedUrl(){
        if(tokenQ){
          const url = apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(tokenQ);
          return url;
        }
        // 2) token が無ければ /auth/issue で発行してから署名URLへ
        if(!lic){ throw new Error("ライセンスが見つからないためダウンロードできません。"); }
        const r = await fetch(apiUrl("/auth/issue"), {
          method:"POST", headers:{"Content-Type":"application/json"},
          body: JSON.stringify({license_key: lic, device_id:"web-dl"})
        });
        const txt = await r.text();
        if(!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
        const data = JSON.parse(txt||"{}");
        if(!data.token) throw new Error("トークンが空です: "+txt);
        return apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(data.token);
      }

      let signedUrl = null;
      try{
        statusEl.textContent = "ダウンロードの準備中…";
        signedUrl = await getSignedUrl();
        aDirect.href = signedUrl;
        statusEl.textContent = "準備できました。「今すぐダウンロード」をクリックしてください。";
      }catch(e){
        console.error(e);
        statusEl.style.display="none";
        errEl.style.display="block";
        errEl.textContent = e.message || String(e);
        btn.disabled = true; aDirect.removeAttribute("href");
        return;
      }

      btn.addEventListener("click", ()=>{
        if(signedUrl){ location.href = signedUrl; }
      });
    })();
  </script>
</body>
</html>
