<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIEC – ダウンロード</title>
  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 16px
    }

    .panel {
      background: #0b1220;
      border: 1px solid #1f2a44;
      border-radius: 16px;
      padding: 20px
    }

    .muted {
      opacity: .85
    }

    .err {
      color: #fecaca;
      margin-top: 12px;
      white-space: pre-wrap
    }

    a {
      color: #93c5fd
    }
  </style>
  <script>
    (function () {
      const RAW_GATE = "https://https://aiec-gate-766292311890.asia-northeast1.run.app";
      const GATE = RAW_GATE.replace(/^https?:\/\/https?:\/\//, 'https://').replace(/\/+$/, '');
      window.AIEC_GATE_BASE = GATE;
    })();
  </script>
</head>

<body>
  <div class="wrap">
    <h1>ダウンロード</h1>
    <div class="panel">
      <p id="status" class="muted">準備中…</p>
      <pre id="error" class="err" style="display:none"></pre>
      <p class="muted">自動で開始しない場合は <a id="manual" href="#">こちら</a> をクリックしてください。</p>
    </div>
  </div>
  <script>
    (async () => {
      const GATE = (window.AIEC_GATE_BASE || "").replace(/^https?:\/\/https?:\/\//, 'https://').replace(/\/+$/, '');
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const manual = document.getElementById("manual");


      function apiUrl(p) { return new URL(p, GATE).href; }


      // 1) クエリ token があればそのままゲートへ
      const tokenQ = new URLSearchParams(location.search).get("token");
      if (tokenQ) {
        const url = apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(tokenQ);
        manual.href = url; statusEl.textContent = "ダウンロードへ遷移しています…"; location.href = url; return;
      }


      // 2) token が無い場合は localStorage の license から issue
      const license = localStorage.getItem("aiec-license");
      if (!license) { errorEl.style.display = "block"; statusEl.style.display = "none"; errorEl.textContent = "ダウンロード許可証を取得できませんでした（ライセンス未保存）"; return; }


      try {
        statusEl.textContent = "許可証を発行中…";
        const r = await fetch(apiUrl("/auth/issue"), { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ license_key: license, device_id: "web-dl" }) });
        const txt = await r.text();
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
        const data = JSON.parse(txt);
        if (!data?.token) throw new Error("トークンが空: " + txt);
        const url = apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(data.token);
        manual.href = url; statusEl.textContent = "ダウンロードへ遷移しています…"; location.href = url;
      } catch (e) { console.error(e); statusEl.style.display = "none"; errorEl.style.display = "block"; errorEl.textContent = e.message || String(e); }
    })();
  </script>
</body>
</html>