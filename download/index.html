<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIEC-Light ダウンロード</title>
  <meta name="robots" content="noindex" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:640px;margin:2em auto;padding:1em}
    .muted{opacity:.8}
    .ok{color:#16a34a}
    .error{color:#e11d48}
    .box{background:#0f1b33;color:#fff;border:1px solid #1b2440;border-radius:12px;padding:12px}
  </style>
</head>
<body>
  <h1>AIEC-Light ダウンロード</h1>
  <p class="muted">購入が完了していれば自動でダウンロードが開始されます。</p>

  <script>
    window.AIEC_GATE_BASE = window.AIEC_GATE_BASE || "https://aiec-gate-766292311890.asia-northeast1.run.app";
  </script>

  <div id="msg" class="box">準備中…</div>
  <div id="error" class="error" style="display:none"></div>

  <script>
    const GATE = (window.AIEC_GATE_BASE || '').replace(/\/$/,'');
    const msgEl = document.getElementById('msg');
    const errEl = document.getElementById('error');

    (async () => {
      if(!GATE){ throw new Error('Gate URL 未設定（window.AIEC_GATE_BASE）'); }

      const q = new URLSearchParams(location.search);
      let token = q.get('token');

      // 保険：successで保存済みのライセンスから token を取り直す（UI表示せず自動）
      if(!token){
        const license = (localStorage.getItem('aiec-license') || '').trim();
        if(!license) throw new Error('ダウンロード用トークンが見つかりません（successページから遷移してください）');

        msgEl.textContent = '認証トークンを再発行中…';
        const r = await fetch(GATE + '/auth/issue', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ license_key: license, device_id: 'web-auto' })
        });
        if(!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
        const j = await r.json();
        token = j?.token;
        if(!token) throw new Error('トークン再発行に失敗しました');
      }

      const dlUrl = `${GATE}/v1/download/light?token=${encodeURIComponent(token)}`;
      msgEl.innerHTML = `ダウンロードを開始します…<br><a class="ok" href="${dlUrl}">開始されない場合はこちら</a>`;
      // 1秒後に自動遷移（ブラウザの自動DL制限に配慮）
      setTimeout(()=> location.href = dlUrl, 1000);
    })().catch(e=>{
      console.error(e);
      msgEl.style.display='none';
      errEl.textContent = e.message || String(e);
      errEl.style.display='block';
    });
  </script>
</body>
</html>
