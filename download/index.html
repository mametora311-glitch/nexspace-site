<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIEC – ダウンロード</title>
  <style>
    body {
      margin: 0;
      background: #0f172a;
      color: #e2e8f0;
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial
    }

    .wrap {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 16px
    }

    .panel {
      background: #0b1220;
      border: 1px solid #1f2a44;
      border-radius: 16px;
      padding: 20px
    }

    .muted {
      opacity: .85
    }

    .err {
      color: #fecaca;
      margin-top: 12px;
      white-space: pre-wrap
    }

    a {
      color: #93c5fd
    }
  </style>
  <script>
    (function () {
      const RAW_GATE = "https://https://aiec-gate-766292311890.asia-northeast1.run.app";
      const GATE = RAW_GATE.replace(/^https?:\/\/https?:\/\//, 'https://').replace(/\/+$/, '');
      window.AIEC_GATE_BASE = GATE;
    })();
  </script>
</head>

<body>
  <div class="wrap">
    <h1>ダウンロード</h1>
    <div class="panel">
      <p id="status" class="muted">準備中…</p>
      <pre id="error" class="err" style="display:none"></pre>
      <p class="muted">自動で開始しない場合は <a id="manual" href="#">こちら</a> をクリックしてください。</p>
    </div>
  </div>
  <script>
    (async () => {
      const GATE = (window.AIEC_GATE_BASE || "").replace(/^https?:\/\/https?:\/\//, 'https://').replace(/\/+$/, '');
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");
      const manual = document.getElementById("manual");


      function apiUrl(p) { return new URL(p, GATE).href; }


      // 1) クエリ token があればそのままゲートへ
      const tokenQ = new URLSearchParams(location.search).get("token");
      if (tokenQ) {
        const url = apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(tokenQ);
        manual.href = url; statusEl.textContent = "ダウンロードへ遷移しています…"; location.href = url; return;
      }


      // 2) token が無い場合は localStorage の license から issue
      const license = localStorage.getItem("aiec-license");
      if (!license) { errorEl.style.display = "block"; statusEl.style.display = "none"; errorEl.textContent = "ダウンロード許可証を取得できませんでした（ライセンス未保存）"; return; }


      try {
        statusEl.textContent = "許可証を発行中…";
        const r = await fetch(apiUrl("/auth/issue"), { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ license_key: license, device_id: "web-dl" }) });
        const txt = await r.text();
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${txt}`);
        const data = JSON.parse(txt);
        if (!data?.token) throw new Error("トークンが空: " + txt);
        const url = apiUrl("/v1/download/light") + "?token=" + encodeURIComponent(data.token);
        manual.href = url; statusEl.textContent = "ダウンロードへ遷移しています…"; location.href = url;
      } catch (e) { console.error(e); statusEl.style.display = "none"; errorEl.style.display = "block"; errorEl.textContent = e.message || String(e); }
    })();
  </script>
  <section id="license-tools" style="margin:28px 0; padding:16px; border:1px solid #333; border-radius:12px;">
    <h3 style="margin:0 0 12px 0;">ライセンスキー</h3>
    <div id="lic-row" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="lic-input" type="text" readonly
        style="flex:1; min-width:300px; padding:8px; border-radius:8px; border:1px solid #444; background:#111; color:#ddd;">
      <button id="btn-copy">コピー</button>
      <button id="btn-save">license.txt 保存</button>
      <button id="btn-qr">QR表示</button>
    </div>
    <div id="qr-wrap" style="margin-top:12px; display:none;"></div>
    <p id="lic-hint" style="opacity:.8; margin-top:8px;">
      ※ ライセンスは購入時に自動発行済み。見つからない場合は<b>購入に使ったブラウザ</b>でこのページを開いてください。
    </p>
  </section>

  <script>
    (function () {
      const $ = (q) => document.querySelector(q);
      const mask = (s) => s.length > 12 ? s.slice(0, 4) + "••••" + s.slice(-4) : s;

      // 1) localStorage から読み出し
      const raw = localStorage.getItem("aiec-license") || "";
      const lic = raw.trim();

      const licInput = $("#lic-input");
      const copyBtn = $("#btn-copy");
      const saveBtn = $("#btn-save");
      const qrBtn = $("#btn-qr");
      const qrWrap = $("#qr-wrap");

      if (!lic) {
        licInput.value = "(見つかりませんでした)";
        copyBtn.disabled = saveBtn.disabled = qrBtn.disabled = true;
        return;
      }
      licInput.value = lic; // 表示はそのまま。見せたくないなら mask(lic) に変更可

      // 2) クリップボード
      copyBtn.addEventListener("click", async () => {
        try { await navigator.clipboard.writeText(lic); copyBtn.textContent = "コピーしました"; setTimeout(() => copyBtn.textContent = "コピー", 1200); }
        catch { alert("コピーに失敗しました"); }
      });

      // 3) license.txt として保存
      saveBtn.addEventListener("click", () => {
        const blob = new Blob([lic + "\n"], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "license.txt";
        a.click();
        URL.revokeObjectURL(a.href);
      });

      // 4) QR表示（外部CDN不要の簡易実装）
      qrBtn.addEventListener("click", () => {
        qrWrap.style.display = "block";
        qrWrap.innerHTML = "";
        const c = document.createElement("canvas");
        qrWrap.appendChild(c);
        // 超簡易QR（中規模までOK）—必要なら本格QRライブラリに置換可能
        // ここでは aiec:license:<key> のスキームにしておく（将来のディープリンク用）
        const data = "aiec:license:" + lic;
        // 最小限のQR生成（誤り訂正なし）:
        // 実運用で精密さが必要なら QRCode.js 等に差し替え推奨
        const drawMiniQR = (canvas, text) => {
          // ダミー：テキストをキャンバスに描画（簡易）。本番はライブラリに差し替えを推奨。
          const ctx = canvas.getContext("2d"); canvas.width = 400; canvas.height = 120;
          ctx.fillStyle = "#111"; ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#0f0"; ctx.font = "16px monospace"; ctx.fillText(text, 10, 60);
        };
        drawMiniQR(c, data);
      });
    })();
  </script>
</body>

</html>