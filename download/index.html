<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>AIEC-Light インストーラー</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 2em auto;
            padding: 1em;
        }

        input,
        button {
            padding: 8px;
        }
    </style>
</head>

<body>
    <h1>AIEC-Light インストーラー</h1>
    <p>ご購入ありがとうございます。認証後にダウンロードが開始できます。</p>

    <div id="license-section">
        <label>ライセンスキー</label>
        <input type="text" id="license-key" placeholder="例: cs_test_xxx" readonly>
        <button onclick="navigator.clipboard.writeText(document.getElementById('license-key').value);">コピー</button>
    </div>

    <form id="auth-form">
        <label>デバイスID（任意、PC名など）</label>
        <input type="text" id="device-id" value="default-device" placeholder="未入力でデフォルト">
        <button type="submit">認証してダウンロード</button>
        <div id="auth-status">認証処理中…</div>
    </form>

    <div id="dl-section" style="display:none;">
        <p>ダウンロードリンク: <a id="dl-link" href="#">インストーラー.zip</a></p>
    </div>

    <script>
        const GATE = window.AIEC_GATE_BASE || '';
        const licenseInput = document.getElementById('license-key');
        const authForm = document.getElementById('auth-form');
        const statusEl = document.getElementById('auth-status');
        const dlSection = document.getElementById('dl-section');
        const dlLink = document.getElementById('dl-link');

        // successからのtoken自動適用（query?token=xxx）
        const urlParams = new URLSearchParams(location.search);
        const autoToken = urlParams.get('token');
        if (autoToken) {
            licenseInput.value = '自動認証済み';
            dlLink.href = `${GATE}/v1/download/light?token=${autoToken}`;
            dlSection.style.display = 'block';
            authForm.style.display = 'none';
            return;
        }

        // 手動フォーム
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const licenseKey = licenseInput.value.trim();
            if (!licenseKey) return alert('ライセンスキーを入力/コピーしてください');
            const deviceId = document.getElementById('device-id').value.trim() || 'default-device';

            try {
                statusEl.textContent = '認証中…';
                const res = await fetch(`${GATE}/auth/issue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ license_key: licenseKey, device_id: deviceId })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const token = data.token;

                dlLink.href = `${GATE}/v1/download/light?token=${token}`;
                dlSection.style.display = 'block';
                authForm.style.display = 'none';
                statusEl.textContent = '認証完了！';
            } catch (err) {
                statusEl.textContent = `エラー: ${err.message}`;
            }
        });

        // ライセンスキー初期化（ローカルストレージor空）
        licenseInput.value = localStorage.getItem('aiec-license') || '';
        licenseInput.addEventListener('input', (e) => localStorage.setItem('aiec-license', e.target.value));
    </script>
</body>

</html>