<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>ご購入ありがとうございます ✓</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2em auto;
      padding: 1em;
    }

    button {
      padding: 8px 16px;
    }
  </style>
</head>

<body>
  <h1>ご購入ありがとうございます ✓</h1>
  <p>ダウンロードページへ移動します…</p>
  <div id="status">処理中…</div>
  <div id="error" style="color:red;display:none;"></div>
  <a id="manual" href="/download" style="display:none;">自動で始まらない場合はこちら</a>
  <br><a href="/aiec-light">製品ページへ戻る</a> | <a href="/">トップへ</a>

  <script>
    const GATE = window.AIEC_GATE_BASE || '';  // Gate URL
    const params = new URLSearchParams(location.search);
    const sessionId = params.get('session_id');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const manualEl = document.getElementById('manual');

    async function api(url, opts) {
      const r = await fetch(`${GATE}${url}`, opts);
      if (!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
      return await r.json();
    }

    if (!sessionId) {
      statusEl.textContent = 'セッション情報が見つかりません。購入フローから再度お試しください。';
      manualEl.style.display = 'inline';
      throw new Error('No session_id');
    }

    (async () => {
      try {
        statusEl.textContent = 'ライセンスを確認中…';
        const claimRes = await api('/v1/claim', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        if (!claimRes.paid) throw new Error('未払い');

        const licenseKey = claimRes.license_key || sessionId;  // Firestoreから
        statusEl.textContent = '認証トークンを発行中…';
        const authRes = await api('/auth/issue', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ license_key: licenseKey, device_id: 'default-device' })  // device_idは後でカスタム
        });
        const token = authRes.token;

        statusEl.innerHTML = `認証完了！ <a href="${GATE}/v1/download/light?token=${token}">ダウンロード開始</a>`;
        // 自動DL: 5秒後リダイレクト
        setTimeout(() => location.href = `${GATE}/v1/download/light?token=${token}`, 3000);
      } catch (e) {
        console.error(e);
        errorEl.textContent = e.message;
        errorEl.style.display = 'block';
        manualEl.style.display = 'inline';
      }
    })();
  </script>
</body>

</html>