<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/base.css" />
  <link rel="stylesheet" href="/css/params.css" />
  <link rel="stylesheet" href="/css/pages/success.css" />
  <title>ご購入ありがとうございます｜NEXSPACE</title>
  <meta http-equiv="Cache-Control" content="no-store">
  <base href="/">
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.7;
      padding: 32px;
      max-width: 860px;
      margin: auto
    }

    h1 {
      font-size: clamp(20px, 2.4vw, 28px);
      margin: 0 0 12px
    }

    .note {
      color: #444;
      margin: 0 0 20px
    }

    .error {
      color: #b00020
    }

    .ok {
      color: #0a7
    }

    .muted {
      color: #666
    }
  </style>
</head>

<body>
  <h1>ご購入ありがとうございます！</h1>
  <p class="note">決済が正常に完了しました。自動でダウンロードを開始します。</p>
  <p id="fallback" class="muted">自動で始まらない場合は、<a id="manual-link" href="#">こちら</a> から保存してください。</p>
  <noscript>
    <p class="error">※JavaScriptを有効にしてください。</p>
  </noscript>

  <script>
    (async () => {
      const GATE = 'https://aiec-gate-766292311890.asia-northeast1.run.app'; // 既に正しい設定のままでOK
      const sid = new URLSearchParams(location.search).get('session_id');
      const fallback = document.getElementById('fallback');
      const manualLink = document.getElementById('manual-link');

      function alertSlice(label, txt, n = 200) {
        alert(`${label}\n` + (txt ? txt.slice(0, n) : '(空)'));
      }

      try {
        if (!sid) { alert('session_id がURLにありません'); return; }

        // 1) claim
        const res = await fetch(`${GATE}/v1/claim`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sid })
        });

        const raw = await res.text();
        if (res.status !== 200) {
          alertSlice(`claim 失敗 status=${res.status}`, raw);
          return;
        }

        // 2) JSONとして解釈を試みる（ダメなら中身を表示）
        let payload = null;
        try { payload = JSON.parse(raw); } catch { alertSlice('claim 200 だがJSONでない', raw); return; }

        const token =
          payload?.download_token ??
          payload?.token ??
          payload?.downloadToken ??
          payload?.data?.download_token ?? null;

        if (!token) {
          alertSlice('claim 200 だが token見当たらず。payload:', raw);
          return;
        }

        // 3) tokenあり → 手動リンク＋自動DL
        const url = `${GATE}/v1/download/light?token=${encodeURIComponent(token)}`;
        manualLink.href = url;
        fallback.innerHTML = `自動で始まらない場合は <a href="${url}">こちら</a> から保存してください。`;

        // 自動DL
        location.href = url;

      } catch (e) {
        alert(`例外: ${e?.message || e}`);
      }
    })();
  </script>

</body>

</html>